apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Production overlay: Use production Relay and VultiServer endpoints
# Does NOT deploy Relay or VultiServer - uses api.vultisig.com
# Usage: kubectl apply -k k8s/overlays/production

resources:
  - ../../base
  - ../../base/vcli/

# Patch configmaps to use production endpoints
patchesStrategicMerge:
  - relay-config-patch-verifier.yaml
  - relay-config-patch-dca.yaml

# Image configuration for production
# Override base images with proper registry and tags
images:
  # DCA Plugin (app-recurring) v1.0.82
  - name: docker.io/library/app-recurring-server:local-amd64
    newName: ghcr.io/vultisig/app-recurring/server
    newTag: v1.0.82
  - name: docker.io/library/app-recurring-worker:local-amd64
    newName: ghcr.io/vultisig/app-recurring/worker
    newTag: v1.0.82
  - name: docker.io/library/app-recurring-scheduler:local-amd64
    newName: ghcr.io/vultisig/app-recurring/scheduler
    newTag: v1.0.82
  - name: docker.io/library/app-recurring-txindexer:local-amd64
    newName: ghcr.io/vultisig/app-recurring/tx_indexer
    newTag: v1.0.82
  # Verifier v0.1.16
  - name: docker.io/library/vultisig-verifier:local-amd64
    newName: ghcr.io/vultisig/verifier/verifier
    newTag: v0.1.16
  - name: docker.io/library/vultisig-worker:local-amd64
    newName: ghcr.io/vultisig/verifier/worker
    newTag: v0.1.16
  - name: docker.io/library/vultisig-tx-indexer:local-amd64
    newName: ghcr.io/vultisig/verifier/tx_indexer
    newTag: v0.1.16
  # VCLI v1.0.1 - fix: GetPluginServerURL reads env vars before defaults
  - name: docker.io/library/vcli:local-amd64
    newName: ghcr.io/vultisig/vcli
    newTag: v1.0.1

# Patch deployments for production GHCR images
patches:
  # Fix imagePullPolicy
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
    target:
      kind: Deployment
      namespace: plugin-dca
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: IfNotPresent
    target:
      kind: Deployment
      namespace: verifier
  # Fix binary paths for GHCR images (use /app/main instead of /app/<component>)
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["/app/main"]
    target:
      kind: Deployment
      name: scheduler
      namespace: plugin-dca
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["/app/main"]
    target:
      kind: Deployment
      name: tx-indexer
      namespace: plugin-dca
  # Verifier namespace patches
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["/app/main"]
    target:
      kind: Deployment
      name: verifier
      namespace: verifier
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["/app/main"]
    target:
      kind: Deployment
      name: worker
      namespace: verifier
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["/app/main"]
    target:
      kind: Deployment
      name: tx-indexer
      namespace: verifier
