apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker
  namespace: plugin-dca
  labels:
    app: dca
    component: worker
spec:
  replicas: 2
  selector:
    matchLabels:
      app: dca
      component: worker
  template:
    metadata:
      labels:
        app: dca
        component: worker
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8088"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: worker
          image: docker.io/library/app-recurring-worker:local-amd64
          imagePullPolicy: Never
          command: ["/app/main"]
          ports:
            - containerPort: 8087
              name: health
            - containerPort: 8088
              name: metrics
          env:
            - name: LOG_FORMAT
              value: "json"
            - name: HEALTHPORT
              value: "8087"
            - name: METRICS_ENABLED
              value: "true"
            - name: METRICS_HOST
              value: "0.0.0.0"
            - name: METRICS_PORT
              value: "8088"
            - name: POSTGRES_DSN
              valueFrom:
                secretKeyRef:
                  name: postgres
                  key: dsn
            - name: REDIS_URI
              valueFrom:
                secretKeyRef:
                  name: redis
                  key: uri
            - name: BLOCKSTORAGE_HOST
              valueFrom:
                configMapKeyRef:
                  name: minio-config
                  key: host
            - name: BLOCKSTORAGE_REGION
              valueFrom:
                configMapKeyRef:
                  name: minio-config
                  key: region
            - name: BLOCKSTORAGE_ACCESSKEY
              valueFrom:
                secretKeyRef:
                  name: minio
                  key: access-key
            - name: BLOCKSTORAGE_SECRETKEY
              valueFrom:
                secretKeyRef:
                  name: minio
                  key: secret-key
            - name: BLOCKSTORAGE_BUCKET
              valueFrom:
                configMapKeyRef:
                  name: minio-config
                  key: bucket
            - name: VAULTSERVICE_RELAY_SERVER
              valueFrom:
                configMapKeyRef:
                  name: relay-config
                  key: url
            - name: VAULTSERVICE_LOCALPARTYPREFIX
              valueFrom:
                configMapKeyRef:
                  name: vault-service-config
                  key: local-party-prefix
            - name: VAULTSERVICE_ENCRYPTIONSECRET
              valueFrom:
                secretKeyRef:
                  name: encryption
                  key: secret
            - name: VAULTSERVICE_DOSETUPMSG
              value: "true"
            - name: VERIFIER_URL
              valueFrom:
                configMapKeyRef:
                  name: verifier-config
                  key: url
            - name: VERIFIER_PARTYPREFIX
              valueFrom:
                configMapKeyRef:
                  name: verifier-config
                  key: party-prefix
            - name: VERIFIER_SENDTOKEN
              valueFrom:
                secretKeyRef:
                  name: verifier-tokens
                  key: send-token
            - name: VERIFIER_SWAPTOKEN
              valueFrom:
                secretKeyRef:
                  name: verifier-tokens
                  key: swap-token
            - name: TASK_QUEUE_NAME
              value: "dca_plugin_queue"
            # RPC endpoints
            - name: RPC_ETHEREUM_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: ethereum
            - name: RPC_ARBITRUM_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: arbitrum
            - name: RPC_AVALANCHE_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: avalanche
            - name: RPC_BSC_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: bsc
            - name: RPC_BASE_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: base
            - name: RPC_OPTIMISM_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: optimism
            - name: RPC_POLYGON_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: polygon
            - name: RPC_SOLANA_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: solana
            - name: THORCHAIN_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: thorchain
            - name: MAYACHAIN_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: mayachain
            - name: ONEINCH_BASEURL
              valueFrom:
                configMapKeyRef:
                  name: swap-providers-config
                  key: oneinch-baseurl
            # Additional RPC endpoints
            - name: RPC_BLAST_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: blast
            - name: RPC_BITCOIN_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: bitcoin
            - name: RPC_XRP_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: xrp
            - name: RPC_ZKSYNC_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: zksync
            - name: RPC_CRONOS_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: cronos
            - name: RPC_COSMOS_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: cosmos
            - name: RPC_MAYA_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: mayachain
            - name: RPC_TRON_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: tron
            - name: RPC_THORCHAIN_URL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: thorchain
            - name: BTC_BLOCKCHAIRURL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: bitcoin
            - name: LTC_BLOCKCHAIRURL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: litecoin
            - name: DOGE_BLOCKCHAIRURL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: dogecoin
            - name: BCH_BLOCKCHAIRURL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: bitcoincash
            - name: DASH_BLOCKCHAIRURL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: dash
            - name: ZEC_BLOCKCHAIRURL
              valueFrom:
                configMapKeyRef:
                  name: rpc-config
                  key: zcash
            - name: SOLANA_JUPITERAPIURL
              value: "https://quote-api.jup.ag/v6"
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8087
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8087
            initialDelaySeconds: 10
            periodSeconds: 10
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "512Mi"
              cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: worker
  namespace: plugin-dca
spec:
  type: ClusterIP
  ports:
    - port: 8088
      targetPort: 8088
      name: metrics
  selector:
    app: dca
    component: worker
