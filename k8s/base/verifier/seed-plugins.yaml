apiVersion: v1
kind: ConfigMap
metadata:
  name: seed-plugins-sql
  namespace: verifier
data:
  seed.sql: |
    -- Seed plugins for Kubernetes deployment
    -- Uses cluster-internal service endpoints

    INSERT INTO plugins (id, title, description, server_endpoint, category, logo_url, thumbnail_url, images, features, faqs, audited, created_at, updated_at)
    VALUES
    (
        'vultisig-fees-feee',
        'Vultisig Fees',
        'Automatic fee collection for Vultisig transactions',
        'http://server.plugin-fee.svc.cluster.local:8085',
        'plugin',
        'https://raw.githubusercontent.com/vultisig/verifier/main/assets/plugins/fees/icon.jpg',
        'https://raw.githubusercontent.com/vultisig/verifier/main/assets/plugins/fees/thumbnail.jpg',
        '[]',
        '["Automatic fee deduction", "Multi-chain support", "Transparent pricing"]',
        '[]',
        false,
        NOW(),
        NOW()
    ),
    (
        'vultisig-dca-0000',
        'DCA (Dollar Cost Averaging)',
        'Automated recurring swaps and transfers',
        'http://server-swap.plugin-dca.svc.cluster.local:8082',
        'app',
        'https://raw.githubusercontent.com/vultisig/verifier/main/assets/plugins/dca/icon.jpg',
        'https://raw.githubusercontent.com/vultisig/verifier/main/assets/plugins/dca/thumbnail.jpg',
        '[]',
        '["Recurring swaps", "Multi-chain support", "Flexible scheduling"]',
        '[]',
        false,
        NOW(),
        NOW()
    ),
    (
        'vultisig-recurring-sends-0000',
        'Recurring Sends',
        'Automated recurring token transfers',
        'http://server-send.plugin-dca.svc.cluster.local:8083',
        'app',
        'https://raw.githubusercontent.com/vultisig/verifier/main/assets/plugins/recurring-sends/icon.jpg',
        'https://raw.githubusercontent.com/vultisig/verifier/main/assets/plugins/recurring-sends/thumbnail.jpg',
        '[]',
        '["Scheduled transfers", "Multi-chain support", "Reliable execution"]',
        '[]',
        false,
        NOW(),
        NOW()
    )
    ON CONFLICT (id) DO UPDATE SET
        server_endpoint = EXCLUDED.server_endpoint,
        category = EXCLUDED.category,
        updated_at = NOW();

    -- Seed plugin API keys (must match secrets in plugin-dca namespace)
    INSERT INTO plugin_apikey (plugin_id, apikey, status)
    VALUES
        ('vultisig-fees-feee', 'k8s-fee-plugin-apikey', 1),
        ('vultisig-dca-0000', 'k8s-dca-swap-apikey', 1),
        ('vultisig-recurring-sends-0000', 'k8s-dca-send-apikey', 1)
    ON CONFLICT (apikey) DO NOTHING;
---
apiVersion: batch/v1
kind: Job
metadata:
  name: seed-plugins
  namespace: verifier
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-verifier
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for verifier to be ready..."
              until wget -q --spider http://verifier.verifier.svc.cluster.local:8080/healthz 2>/dev/null; do
                echo "Verifier not ready, waiting..."
                sleep 5
              done
              echo "Verifier is ready!"
      containers:
        - name: seed
          image: postgres:15-alpine
          command:
            - sh
            - -c
            - |
              echo "Running plugin seed SQL..."
              PGPASSWORD="$POSTGRES_PASSWORD" psql -h postgres.infra.svc.cluster.local -U "$POSTGRES_USER" -d vultisig-verifier -f /seed/seed.sql
              echo "Plugin seeding completed!"
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres
                  key: password
          volumeMounts:
            - name: seed-sql
              mountPath: /seed
      volumes:
        - name: seed-sql
          configMap:
            name: seed-plugins-sql
